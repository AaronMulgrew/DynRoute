<html>
<head>
    <title>Leaflet.js Demo</title>
    <meta charset="utf-8">

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="MovingMarker.js"></script>

    <style type="text/css">
        html, body {
            height: 100%;
        }

        #map {
            height: 60%;
        }

        #slidecontainer {
            #margin-top: 60%;
            width: 90%;
        }
    </style>

</head>
<body>
    <div id="map"></div>
    <div id="slidecontainer">
        <input type="range" min="200" max="3000" value="500" class="slider" id="myRange">
        <p>Value: <span id="demo"></span></p>
    </div>

    <script type="text/javascript">

	var map = L.map('map').setView([52.634204, -1.132845], 15);

	L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: 'OSM'})
	.addTo(map);

	var line = L.polyline([[40.68510, -73.94136], [40.68576, -73.94149], [40.68649, -73.94165]]);
	map.addLayer(line);

	var marker = L.marker([40.68510, -73.94136]).addTo(map);

	function removeMarker(selectedMarker) {
		if (selectedMarker) {
		map.removeLayer(selectedMarker);
		}
	}

	var interval = window.setInterval(function(){
		/// call your function here
		httpGetAsync("http://localhost:5000", process_coord);
	}, 500);

	//var myMovingMarker;

	//httpGetAsync("http://localhost:5000", process_coord);
	function httpGetAsync(theUrl, callback, marker = null)
	{
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.onreadystatechange = function() {
			if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
			{
				console.log(xmlHttp.responseText);
				if (marker)
				{
					callback(xmlHttp.responseText, marker);
				}
				else
				{
					callback(xmlHttp.responseText);
				}
			}
		}
		xmlHttp.open("GET", theUrl, true); // true for asynchronous
		xmlHttp.send(null);
		//alert(theUrl);
	}
	function process_coord(data, myMovingMarker = null)
	{
		if(data === "false" || !data)
		{
			removeMarker(myMovingMarker);
		}
		else
		{
			if (myMovingMarker)
			{
				removeMarker(myMovingMarker);
			}
			var obj = JSON.parse(data);

			// convert the time in miliseconds to seconds
			timeSecs = obj.time * 1000;
			
			console.log(obj);
			var myMovingMarker = L.Marker.movingMarker([[obj.lat, obj.lon],[obj.route.lat, obj.route.lon]],
				[timeSecs]).addTo(map);
			myMovingMarker.start();
			setTimeout(NewCoords, timeSecs, [obj.route.lat, obj.route.lon], myMovingMarker);
		}
		//marker = new L.marker([obj.lat, obj.lon]).addTo(map);

		//setTimeout(removeMarker, 10000, myMovingMarker);
	}


	function NewCoords(latlon, marker)
	{
		latitude = latlon[0];
		longitude = latlon[1];
		httpGetAsync("http://localhost:5000/coordinates/" + latitude + ":" + longitude, process_coord, marker);
		console.log(latlon);
	}

	var slider = document.getElementById("myRange");
	var output = document.getElementById("demo");
	output.innerHTML = slider.value;

	slider.oninput = function() {
	  getNewCarsInterval = this.value;
  	  output.innerHTML = getNewCarsInterval;
	  clearInterval(interval);
	  interval = 0;
	  interval = window.setInterval(function(){
		/// call your function here
		httpGetAsync("http://localhost:5000", process_coord);
      }, getNewCarsInterval);
	  //alert(this.value);
	}



	//map.addLayer(marker);
	//marker.setLatLng([lat, lng]).update();

    //var animatedMarker = L.animatedMarker(line.getLatLngs());
	//map.addLayer(animatedMarker);

    </script>

</body>
</html>